{% extends "base.html" %}

{% block title %}Flujo E: Configuración de Filtros{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <h1 class="text-center mb-4">Flujo E: Configuración de Filtros</h1>
    <form id="filtrosForm" method="POST">
      {% for diam in selected_diametros %}
        {# normalizamos el diámetro para usarlo en los IDs #}
        {% set safe = diam
             | replace('/', '_')
             | replace(' ', '_')
             | replace('.', '_') %}
        <div class="card mb-3">
          <div class="card-header">
            Para DIÁMETRO: {{ diam }}
          </div>
          <div class="card-body">
            <!-- TIPO -->
            <div class="mb-3">
              <label for="tipo_{{ safe }}" class="form-label">
                Selecciona uno o más <strong>TIPO</strong>:
              </label>
              <select
                id="tipo_{{ safe }}"
                name="tipo_{{ diam }}"
                class="form-select cascade"
                data-field="tipos"
                data-diam="{{ diam }}"
                multiple
                size="5"
              >
                {% for t in filtros[diam].tipos %}
                  <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- GRADO DE ACERO -->
            <div class="mb-3">
              <label for="acero_{{ safe }}" class="form-label">
                <strong>GRADO DE ACERO</strong>:
              </label>
              <select
                id="acero_{{ safe }}"
                name="acero_{{ diam }}"
                class="form-select cascade"
                data-field="aceros"
                data-diam="{{ diam }}"
              >
                <option value="">Seleccionar</option>
                {% for a in filtros[diam].acero %}
                  <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- GRADO DE ACERO CUPLA -->
            <div class="mb-3">
              <label for="acero_cup_{{ safe }}" class="form-label">
                <strong>GRADO DE ACERO CUPLA</strong>:
              </label>
              <select
                id="acero_cup_{{ safe }}"
                name="acero_cup_{{ diam }}"
                class="form-select cascade"
                data-field="aceros_cup"
                data-diam="{{ diam }}"
              >
                <option value="">Seleccionar</option>
                {% for c in filtros[diam].acero_cup %}
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            </div>
            <!-- TIPO DE CUPLA -->
            <div class="mb-3">
              <label for="tipo_cup_{{ safe }}" class="form-label">
                <strong>TIPO DE CUPLA</strong>:
              </label>
              <select
                id="tipo_cup_{{ safe }}"
                name="tipo_cup_{{ diam }}"
                class="form-select"
                data-diam="{{ diam }}"
              >
                <option value="">Seleccionar</option>
                {% for tc in filtros[diam].tipo_cup %}
                  <option value="{{ tc }}">{{ tc }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
      {% endfor %}

      <div class="text-center">
        <button type="submit" class="btn btn-primary btn-lg">
          Aplicar Filtros
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Helper para normalizar cadenas a IDs válidos
  function slug(d) {
    return d.replace(/[^a-zA-Z0-9]/g, "_");
  }

  // Lista inicial de diámetros (viene del servidor)
  const diameters = {{ selected_diametros|tojson }};

  // Repuebla un <select multiple>
  function populateMultiple(el, opts) {
    el.innerHTML = "";
    opts.forEach(v => {
      const o = document.createElement("option");
      o.value = v; o.text = v;
      el.appendChild(o);
    });
  }

  // Repuebla un <select> de uno solo
  function populateSingle(el, opts) {
    el.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = ""; placeholder.text = "Seleccionar";
    el.appendChild(placeholder);
    opts.forEach(v => {
      const o = document.createElement("option");
      o.value = v; o.text = v;
      el.appendChild(o);
    });
  }

  // Ejecuta la recarga en cascada leyendo los valores actuales de los selects
  function updateFilters() {
    const params = new URLSearchParams();

    // agregamos todos los diámetros actuales
    diameters.forEach(d => params.append("diametros", d));

    // para cada diámetro, coleccionamos TIPO, ACERO y ACERO_CUP actuales
    diameters.forEach(d => {
      const id = slug(d);

      const tipoEl = document.getElementById(`tipo_${id}`);
      Array.from(tipoEl?.selectedOptions || [])
           .map(o => o.value)
           .filter(v => v)
           .forEach(v => params.append("tipos", v));

      const acEl = document.getElementById(`acero_${id}`);
      if (acEl?.value) params.append("aceros", acEl.value);

      const acCEl = document.getElementById(`acero_cup_${id}`);
      if (acCEl?.value) params.append("aceros_cup", acCEl.value);
    });

    fetch(`/api/flujo_e/filters_all?${params.toString()}`)
      .then(res => res.json())
      .then(js => {
        diameters.forEach(d => {
          const id = slug(d);
          populateMultiple(
            document.getElementById(`tipo_${id}`), js.tipos
          );
          populateSingle(
            document.getElementById(`acero_${id}`), js.aceros
          );
          populateSingle(
            document.getElementById(`acero_cup_${id}`), js.aceros_cup
          );
          populateSingle(
            document.getElementById(`tipo_cup_${id}`), js.tipo_cup
          );
        });
      })
      .catch(e => console.error("Cascade error:", e));
  }

  // Asociamos el listener a todos los selects de cascada
  diameters.forEach(d => {
    const id = slug(d);
    ["tipo", "acero", "acero_cup"].forEach(field => {
      const el = document.getElementById(`${field}_${id}`);
      if (el) el.addEventListener("change", updateFilters);
    });
  });

  // (Opcional) arrancar ya filtrado según estado inicial
  updateFilters();
});
</script>
{% endblock %}












